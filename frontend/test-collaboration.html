<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Collaboration Test - Inventory Management</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    
    .test-section {
      background: white;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    h1 {
      color: #333;
      border-bottom: 3px solid #667eea;
      padding-bottom: 10px;
    }
    
    h2 {
      color: #667eea;
      margin-top: 0;
    }
    
    .status {
      display: inline-block;
      padding: 5px 15px;
      border-radius: 20px;
      font-weight: 600;
      font-size: 14px;
    }
    
    .status.connected {
      background: #d4edda;
      color: #155724;
    }
    
    .status.disconnected {
      background: #f8d7da;
      color: #721c24;
    }
    
    .status.connecting {
      background: #fff3cd;
      color: #856404;
    }
    
    button {
      background: #667eea;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      margin: 5px;
    }
    
    button:hover {
      background: #5568d3;
    }
    
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    #log {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 15px;
      border-radius: 5px;
      max-height: 400px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      line-height: 1.5;
    }
    
    .log-entry {
      margin: 5px 0;
    }
    
    .log-success { color: #4ec9b0; }
    .log-error { color: #f48771; }
    .log-info { color: #9cdcfe; }
    .log-warning { color: #dcdcaa; }
    
    .user-list {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 10px;
    }
    
    .user-card {
      background: #f8f9fa;
      padding: 10px 15px;
      border-radius: 5px;
      border-left: 4px solid;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 14px;
    }
    
    input[type="text"] {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      width: 200px;
    }
  </style>
</head>
<body>
  <h1>ðŸ”„ Real-time Collaboration Test</h1>
  
  <div class="test-section">
    <h2>Connection Status</h2>
    <p>
      Status: <span class="status connecting" id="connectionStatus">Disconnected</span>
    </p>
    <p id="connectionInfo">Not connected</p>
    <button id="connectBtn">Connect</button>
    <button id="disconnectBtn" disabled>Disconnect</button>
  </div>
  
  <div class="test-section">
    <h2>User Information</h2>
    <label>
      Username: 
      <input type="text" id="usernameInput" value="TestUser" placeholder="Enter your username">
    </label>
    <label>
      User ID: 
      <input type="text" id="userIdInput" value="test-user-1" placeholder="Enter user ID">
    </label>
  </div>
  
  <div class="test-section">
    <h2>Active Users</h2>
    <div id="usersList" class="user-list">
      <em>No users connected</em>
    </div>
  </div>
  
  <div class="test-section">
    <h2>Test Actions</h2>
    <button id="joinRoomBtn" disabled>Join Inventory Room</button>
    <button id="updateCursorBtn" disabled>Update Cursor Position</button>
    <button id="broadcastUpdateBtn" disabled>Broadcast Test Update</button>
    <button id="requestPresenceBtn" disabled>Request Presence</button>
  </div>
  
  <div class="test-section">
    <h2>Event Log</h2>
    <button onclick="document.getElementById('log').innerHTML = ''">Clear Log</button>
    <div id="log"></div>
  </div>
  
  <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
  <script>
    let socket = null;
    let isConnected = false;
    
    const log = (message, type = 'info') => {
      const logDiv = document.getElementById('log');
      const entry = document.createElement('div');
      entry.className = `log-entry log-${type}`;
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      logDiv.appendChild(entry);
      logDiv.scrollTop = logDiv.scrollHeight;
      console.log(message);
    };
    
    const updateStatus = (status, info = '') => {
      const statusEl = document.getElementById('connectionStatus');
      const infoEl = document.getElementById('connectionInfo');
      
      statusEl.className = `status ${status}`;
      statusEl.textContent = status.charAt(0).toUpperCase() + status.slice(1);
      infoEl.textContent = info;
      
      isConnected = status === 'connected';
      updateButtons();
    };
    
    const updateButtons = () => {
      document.getElementById('connectBtn').disabled = isConnected;
      document.getElementById('disconnectBtn').disabled = !isConnected;
      document.getElementById('joinRoomBtn').disabled = !isConnected;
      document.getElementById('updateCursorBtn').disabled = !isConnected;
      document.getElementById('broadcastUpdateBtn').disabled = !isConnected;
      document.getElementById('requestPresenceBtn').disabled = !isConnected;
    };
    
    const renderUsers = (users) => {
      const usersList = document.getElementById('usersList');
      
      if (!users || users.length === 0) {
        usersList.innerHTML = '<em>No users connected</em>';
        return;
      }
      
      usersList.innerHTML = '';
      users.forEach(user => {
        const userCard = document.createElement('div');
        userCard.className = 'user-card';
        
        // Sanitize color - only allow hex colors
        const sanitizedColor = /^#[0-9A-Fa-f]{6}$/.test(user.color) ? user.color : '#667eea';
        userCard.style.borderLeftColor = sanitizedColor;
        
        const avatar = document.createElement('div');
        avatar.className = 'user-avatar';
        avatar.style.backgroundColor = sanitizedColor;
        avatar.textContent = getInitials(user.username);
        
        const info = document.createElement('div');
        const username = document.createElement('strong');
        username.textContent = user.username;
        const userId = document.createElement('small');
        userId.textContent = `ID: ${user.user_id}`;
        
        info.appendChild(username);
        info.appendChild(document.createElement('br'));
        info.appendChild(userId);
        
        userCard.appendChild(avatar);
        userCard.appendChild(info);
        usersList.appendChild(userCard);
      });
    };
    
    const getInitials = (name) => {
      const parts = name.split(' ');
      if (parts.length >= 2) {
        return (parts[0][0] + parts[1][0]).toUpperCase();
      }
      return name.substring(0, 2).toUpperCase();
    };
    
    document.getElementById('connectBtn').addEventListener('click', () => {
      const wsUrl = window.location.origin;
      log(`Connecting to ${wsUrl}/ws...`, 'info');
      updateStatus('connecting', 'Attempting to connect...');
      
      socket = io(wsUrl, {
        path: '/ws/socket.io',
        transports: ['websocket', 'polling'],
        reconnection: true,
        reconnectionAttempts: 5,
        reconnectionDelay: 1000,
      });
      
      socket.on('connect', () => {
        log(`âœ… Connected! Socket ID: ${socket.id}`, 'success');
        updateStatus('connected', `Socket ID: ${socket.id}`);
      });
      
      socket.on('disconnect', (reason) => {
        log(`âŒ Disconnected: ${reason}`, 'error');
        updateStatus('disconnected', `Reason: ${reason}`);
      });
      
      socket.on('connect_error', (error) => {
        log(`âš ï¸ Connection error: ${error.message}`, 'error');
        updateStatus('disconnected', `Error: ${error.message}`);
      });
      
      socket.on('connection_established', (data) => {
        log(`ðŸ“¡ Connection established: ${JSON.stringify(data)}`, 'success');
      });
      
      socket.on('room_joined', (data) => {
        log(`ðŸ  Joined room! Users: ${data.users.length}`, 'success');
        log(`Your color: ${data.user.color}`, 'info');
        renderUsers(data.users);
      });
      
      socket.on('user_joined', (data) => {
        log(`ðŸ‘‹ ${data.username} joined (${data.user_id})`, 'info');
      });
      
      socket.on('user_left', (data) => {
        log(`ðŸ‘‹ ${data.username} left (${data.user_id})`, 'warning');
      });
      
      socket.on('cursor_updated', (data) => {
        log(`ðŸ‘† ${data.username} is viewing row: ${data.editing_row || 'none'}`, 'info');
      });
      
      socket.on('inventory_changed', (data) => {
        log(`ðŸ“ ${data.username} updated ${data.field} for ${data.sku}`, 'success');
        log(`   Old: ${data.old_value} â†’ New: ${data.new_value}`, 'info');
      });
      
      socket.on('presence_update', (data) => {
        log(`ðŸ‘¥ Presence update: ${data.users.length} users`, 'info');
        renderUsers(data.users);
      });
    });
    
    document.getElementById('disconnectBtn').addEventListener('click', () => {
      if (socket) {
        socket.disconnect();
        socket = null;
        log('Disconnected manually', 'warning');
        updateStatus('disconnected', 'Manually disconnected');
      }
    });
    
    document.getElementById('joinRoomBtn').addEventListener('click', () => {
      const username = document.getElementById('usernameInput').value || 'TestUser';
      const userId = document.getElementById('userIdInput').value || 'test-user-1';
      
      log(`Joining inventory room as ${username}...`, 'info');
      socket.emit('join_inventory_room', {
        user_id: userId,
        username: username
      });
    });
    
    document.getElementById('updateCursorBtn').addEventListener('click', () => {
      const randomSku = `TEST-SKU-${Math.floor(Math.random() * 1000)}`;
      log(`Updating cursor to ${randomSku}`, 'info');
      socket.emit('update_cursor', {
        row_id: randomSku,
        position: { x: 100, y: 200 }
      });
    });
    
    document.getElementById('broadcastUpdateBtn').addEventListener('click', () => {
      const testUpdate = {
        update_type: 'edit',
        sku: 'TEST-SKU-999',
        field: 'qty_ordered_jason',
        old_value: 10,
        new_value: 15
      };
      log(`Broadcasting test update: ${JSON.stringify(testUpdate)}`, 'info');
      socket.emit('inventory_update', testUpdate);
    });
    
    document.getElementById('requestPresenceBtn').addEventListener('click', () => {
      log('Requesting presence update...', 'info');
      socket.emit('request_presence');
    });
    
    log('Test page loaded. Click "Connect" to start.', 'info');
  </script>
</body>
</html>
