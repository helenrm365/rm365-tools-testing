<!-- Universal Animated Sidebar Component -->
<nav id="sidebar" class="sidebar" aria-label="Main Navigation">
  <!-- Profile Section -->
  <div class="sidebar-header">
    <div class="profile-section">
      <div class="logo-container">
        <img src="/assets/RM365_Logo.png" alt="RM365 Logo" class="sidebar-logo">
      </div>
      <div class="profile-info">
        <h4 id="profileName" class="profile-name">User</h4>
        <span id="profileSubtitle" class="profile-role">Dashboard</span>
      </div>
    </div>

    <div class="search-container">
      <span class="search-icon" aria-hidden="true">ğŸ”</span>
      <input 
        type="text" 
        id="searchInput" 
        class="search-input" 
        placeholder="Search modules..." 
        aria-label="Search navigation items"
      />
    </div>
  </div>

  <div class="sidebar-divider"></div>

  <!-- Navigation Menu -->
  <ul class="sidebar-nav" role="list">
    <li role="listitem">
      <a class="nav-item" data-nav href="/enrollment" aria-label="Enrollment">
        <span class="nav-icon" aria-hidden="true">ğŸ“</span>
        <span class="nav-label">Enrollment</span>
      </a>
    </li>
    <li role="listitem">
      <a class="nav-item" data-nav href="/attendance" aria-label="Attendance">
        <span class="nav-icon" aria-hidden="true">ğŸ•’</span>
        <span class="nav-label">Attendance</span>
      </a>
    </li>
    <li role="listitem">
      <a class="nav-item" data-nav href="/labels" aria-label="Labels">
        <span class="nav-icon" aria-hidden="true">ğŸ·ï¸</span>
        <span class="nav-label">Labels</span>
      </a>
    </li>
    <li role="listitem">
      <a class="nav-item" data-nav href="/salesdata" aria-label="Sales Data">
        <span class="nav-icon" aria-hidden="true">ğŸ“Š</span>
        <span class="nav-label">Sales Data</span>
      </a>
    </li>
    <li role="listitem">
      <a class="nav-item" data-nav href="/inventory" aria-label="Inventory">
        <span class="nav-icon" aria-hidden="true">ğŸ“¦</span>
        <span class="nav-label">Inventory</span>
      </a>
    </li>
    <li role="listitem">
      <a class="nav-item" data-nav href="/usermanagement" aria-label="User Management">
        <span class="nav-icon" aria-hidden="true">ğŸ‘¤</span>
        <span class="nav-label">User Management</span>
      </a>
    </li>
  </ul>

  <div class="sidebar-divider"></div>

  <!-- Footer Section -->
  <div class="sidebar-footer">
    <button id="logoutBtn" class="footer-button" aria-label="Logout">
      <span class="nav-icon" aria-hidden="true">ğŸšª</span>
      <span class="nav-label">Logout</span>
    </button>
    
    <div class="dark-mode-toggle">
      <span class="nav-icon" aria-hidden="true">ğŸŒ™</span>
      <label class="toggle-switch" aria-label="Toggle dark mode">
        <input type="checkbox" id="darkModeToggle" aria-checked="false">
        <span class="toggle-slider"></span>
      </label>
      <span class="nav-label">Dark Mode</span>
    </div>
  </div>
</nav>

<script>
// Universal sidebar functionality
(function() {
  'use strict';
  
  if (window.sidebarInitialized) return;
  window.sidebarInitialized = true;
  
  const THEME_KEY = 'darkMode';
  const USER_KEY = 'user';
  
  function initDarkMode() {
    const toggle = document.getElementById('darkModeToggle');
    if (!toggle) {
      console.warn('[Sidebar] Dark mode toggle not found');
      return;
    }
    
    console.log('[Sidebar] Initializing dark mode');
    
    const stored = localStorage.getItem(THEME_KEY);
    const prefersDark = window.matchMedia?.('(prefers-color-scheme: dark)').matches;
    const isDark = stored === 'true' || (stored == null && prefersDark);
    
    // Check the actual current state of the HTML element
    const currentlyDark = document.documentElement.classList.contains('dark-mode');
    
    console.log('[Sidebar] Dark mode state:', { stored, prefersDark, isDark, currentlyDark });
    
    // Sync the toggle with the actual current state
    toggle.checked = currentlyDark;
    toggle.setAttribute('aria-checked', String(currentlyDark));
    
    // If there's a mismatch, update localStorage to match reality
    if (currentlyDark !== isDark) {
      localStorage.setItem(THEME_KEY, String(currentlyDark));
    }
    
    toggle.addEventListener('change', (e) => {
      const enabled = e.target.checked;
      console.log('[Sidebar] Dark mode toggled:', enabled);
      document.documentElement.classList.toggle('dark-mode', enabled);
      localStorage.setItem(THEME_KEY, String(enabled));
      toggle.setAttribute('aria-checked', String(enabled));
    });
  }
  
  function initSearch() {
    const searchInput = document.getElementById('searchInput');
    if (!searchInput) return;
    
    searchInput.addEventListener('input', (e) => {
      const query = e.target.value.trim().toLowerCase();
      const navItems = document.querySelectorAll('.sidebar .nav-item');
      
      navItems.forEach(item => {
        const label = item.querySelector('.nav-label')?.textContent?.toLowerCase() || '';
        const listItem = item.closest('li');
        if (listItem) {
          listItem.style.display = label.includes(query) ? '' : 'none';
        }
      });
    });
  }
  
  function highlightActiveNav(pathname = location.pathname) {
    document.querySelectorAll('.sidebar .nav-item').forEach(link => {
      const listItem = link.closest('li');
      const isActive = link.getAttribute('href') === pathname;
      
      if (listItem) {
        listItem.classList.toggle('active', isActive);
        link.setAttribute('aria-current', isActive ? 'page' : 'false');
      }
    });
  }
  
  function initNavigation() {
    highlightActiveNav();
    
    window.addEventListener('popstate', () => highlightActiveNav());
    
    document.addEventListener('click', (e) => {
      const link = e.target.closest('a[data-nav]');
      if (link?.getAttribute('href')?.startsWith('/')) {
        setTimeout(() => highlightActiveNav(link.getAttribute('href')), 0);
      }
    });
  }
  
  function initLogout() {
    const logoutBtn = document.getElementById('logoutBtn');
    if (!logoutBtn) return;
    
    logoutBtn.addEventListener('click', async () => {
      if (!confirm('Are you sure you want to log out?')) return;
      
      localStorage.removeItem('authToken');
      localStorage.removeItem(USER_KEY);
      
      if (window.navigate) {
        await window.navigate('/login');
      } else {
        window.location.href = '/login';
      }
    });
  }
  
  function loadUserProfile() {
    try {
      const user = JSON.parse(localStorage.getItem(USER_KEY) || '{}');
      const profileName = document.getElementById('profileName');
      const profileSubtitle = document.getElementById('profileSubtitle');
      
      if (profileName && user.name) {
        profileName.textContent = user.name;
      }
      if (profileSubtitle && user.role) {
        profileSubtitle.textContent = user.role;
      }
    } catch (e) {
      console.warn('[Sidebar] Could not load user profile:', e);
    }
  }
  
  function initMobileToggle() {
    const createToggle = () => {
      if (document.querySelector('.mobile-sidebar-toggle')) return;
      
      const toggle = document.createElement('button');
      toggle.className = 'mobile-sidebar-toggle';
      toggle.innerHTML = 'â˜°';
      toggle.setAttribute('aria-label', 'Toggle Sidebar');
      toggle.setAttribute('aria-expanded', 'false');
      
      toggle.addEventListener('click', () => {
        const sidebar = document.getElementById('sidebar');
        if (sidebar) {
          const isOpen = sidebar.classList.toggle('mobile-open');
          toggle.setAttribute('aria-expanded', String(isOpen));
        }
      });
      
      document.body.appendChild(toggle);
    };
    
    const removeToggle = () => {
      const toggle = document.querySelector('.mobile-sidebar-toggle');
      toggle?.remove();
      
      const sidebar = document.getElementById('sidebar');
      sidebar?.classList.remove('mobile-open');
    };
    
    const handleResize = () => {
      if (window.innerWidth <= 768) {
        createToggle();
      } else {
        removeToggle();
      }
    };
    
    handleResize();
    window.addEventListener('resize', handleResize);
  }
  
  function init() {
    initDarkMode();
    initSearch();
    initNavigation();
    initLogout();
    loadUserProfile();
    initMobileToggle();
    
    console.log('[Sidebar] Initialized successfully');
  }
  
  // Wait for the sidebar HTML to be fully inserted into the DOM
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    // Use setTimeout to ensure HTML is parsed even if document is already ready
    setTimeout(init, 0);
  }
})();
</script>
